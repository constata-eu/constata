{% extends "partials/_base_layout.html" %}

{% block body %}
<div class="container">
  <p class="lead-text">// Developer Guide &ndash; march 2023 &ndash; by nubis //</p>

  <h1>From &empty; &#8614; issuing diplomas.</h1>

  <p class="sub-title"/>certificates of attendance &amp; badges too</p>

  <div class="in-columns">
    <p>
      You can use <strong>CONSTATA</strong> to issue certified documents in <strong>verifiable HTML format</strong>, digitally signed by you, and timestamped in the <strong>Bitcoin blockchain</strong>.
    </p>

    <p>
      A <strong>verifiable html document</strong> is a diploma, certificate of attendance or badge, that can be
      shared online or downloaded and stored. It can be viewed and verified by anyone, using only their default web browser &mdash; forever.
    </p>

    <p>
      These documents are generated from a template. This guide will show you how to issue a batch of diplomas from the default template,
      interacting with our GraphQL API from the command line.
    </p>

    <p>
      You should <strong>eventually hire us</strong> to make you a template with a custom look
      that can also include extra information such as a student photo, grades and transcripts.
    </p>
  </div>

  <h2>Who's this guide for? How is it used?</h2>

  <div class="in-columns">
    <p>
      This guide is for <strong>sysadmins</strong> writing shell scripts that use Constata,
      and <strong>technical people</strong> looking into the issuances API capabilities.
    </p>

    <p>
      It's meant to be followed step by step in BASH for Linux,
      but should work on Windows and Mac with minimal changes.
    </p>

    <p>
      If you need help, find an error, or juts find it confusing, email us at 
      <a href="mailto:devops@constata.eu">devops@constata.eu</a>
    </p>

    <p>
      <strong>Are you a developer</strong> integrating our API? After reading this, check out our <a href="https://api.constata.eu/#/graphiql">GraphQL API explorer</a> 
      and <a href="https://github.com/constata-eu">github repo</a> &mdash; specially the <a href="https://github.com/constata-eu/constata/tree/master/constata_cli">rust client library</a> which powers the command line tool, and the <a href="https://github.com/constata-eu/dotnet-graphql-client">C# client library</a>.
    </p>

    <p>
      <strong>Non technical?</strong>
      No worries, we have a <strong>WEB3</strong> app to do this right from your browser,
      <a href="https://constata.eu">just go here</a>.
    </p>

  </div>

  <h2>Steps</h2>

  <ol>
    <li>Generate your <strong>constata digital signature</strong> to authenticate.</li>
    <li>Get the command line utility.</li>
    <li>List the students in a CSV file.</li>
    <li>Submit your CSV to create an Issuance.</li>
    <li>Sign the diplomas &mdash; after optionally reviewing them.</li>
    <li>Wait until they're certified and emailed to students.</li>
  </ol>

  <ol>
    <li>You'll start by signing up to Constata to get your credentials file.</li>
    <li>After that, you'll download Constata's command line utility.</li>
    <li>Then you'll make a CSV file with all your diploma recipients, with one recipient per row.</li>
    <li>You'll feed the CSV file to the command line utility, creating a new template and generating the diplomas from it, which will result in what we call an "Issuance".</li>
    <li>Once you create an "Issuance" you'll have a chance to review and sign its diplomas, which we also reffer to as "Entries".</li>
    <li>Signed Issuances are queued to be timestamped by Constata, and all entries are optionally sent to each recipient via email.</li>
    <li>You can always query or export the Issuance to know its state and to revisit its Entries.</li>
  </ol>

  # About our API, GraphQL, Authentication and Client tool.

  Constata's API uses a custom authentication mechanism where each request must be signed using a Secp256k1 Private Key
  (as seen in Bitcoin), following the "Bitcoin Sign Message" protocol.

  The signature is applied to the path, method, body and query of the HTTP request, and it also includes a nonce value to prevent replays.

  The API format is GraphQL, which builds on top of HTTP to query and transmit structured, machine readable, relational data.

  Constata provides a command line tool whose commands perform these authenticated GraphQL requests.

  The command line tool is open source and also available as pre-compiled statically linked binaries (that is, no dependencies) for Linux, Mac and Windows.

  # Summary

  We'll show a short and a longer way to create your Issuance.
  In the short version, you'll send a CSV and just wait until we tell you it's done.

  In the longer version you'll be able to build an Issuance incrementally, and review the
  diplomas before you sign them.

  You'll start by signing up to Constata to get your credentials file.
  After that, you'll download Constata's command line utility.
  Then you'll make a CSV file with all your diploma recipients, with one recipient per row.
  You'll feed the CSV file to the command line utility, creating a new template and generating the diplomas from it, which will result in what we call an "Issuance".
  Once you create an "Issuance" you'll have a chance to review and sign its diplomas, which we also reffer to as "Entries".
  Signed Issuances are queued to be timestamped by Constata, and all entries are optionally sent to each recipient via email.
  You can always query or export the Issuance to know its state and to revisit its Entries.

  ## 0. Signup to constata.
  Just visit https://api.constata.eu and follow the steps to "Create a signature".
  You will get a "credentials.json" file with an encrypted private key, generated in your browser.
  You'll use that same file to authenticate using the command line utility.

  ## 1. Download the CLI.
  Get our pre-compiled command line utility here.
  ```curl latest github release
  ```

  If you want to build it yourself, check out the repository for instructions:
  This guide is for Linux, but MacOs and Windows binaries are also available at: ...

  ## 2. Make a CSV file with your diploma recipients.
  You can use any spreadsheet software for it, using "," or ";" as separator.

  ```
  echo "..." > recipients.csv
  ```

  ** Constata can also build custom templates for you, which may have a different schema and column names. An example CSV will be provided to you in those cases. You can also see all your templates and schemas in ..templates.. **

  ## 3. Submit a new Issuance with a new template.

  All diplomas, certificates of attendance and badges are generated from a template.

  Since you don't have any templates yet, we'll create a new one for your diplomas, and the diplomas, in a single command.

  ```
  constata-cli issuance submit --new-template-issuer="Big Data School" --csv=recipients.csv

  >>> 393
  ```
  The command outputs the newly submitted issuance id.

  *** You can re-use a template, or use custom template provided by Constata
  constata-cli issuance submit --template-id=<template-id> --csv=recipients.csv

  *** This example will create a basic template with the text "Big Data School" as the logo, but you can use your own png or jpeg image instead.
    constata-cli issuance create --new-template-logo=/tmp/logo.png --csv=recipients.csv
    You can also create templates for certificates of attendance or invitations, or use a custom one, check the command line utility's help for more info.

    ```constata-cli help issuance```

  ## 4. Wait until the CSV is processed and the Issuance entries are created.

  Your CSV file will be processed asyncronously, errors may ocurr if the CSV file was invalid, or if it was missing required columns.

  This command blocks until the issuance and its entries have been created, or until the processing fails. Exit code 0 means the issuance was created.

  ```
  constata-cli issuance is_created <issuance-id>
  ```

  If the issuance could not be created, you can export and download it as a csv.
  You'll get the original data along with extra columns for error messages.
  ```
  constata-cli issuance export <issuance-id>
  ```

  You can also query the issuance as a JSON document, we suggest using the jq command to parse it.
  ```
  constata-cli issuance show <issuance-id>
  ```

  ## 4. Review and Sign

  Reviewing the generated diplomas is an interactive and optional step, you can get a sample of what your diplomas look like with:
  constata-cli issuance sample-preview issuance-id

  You can also get a preview for a specific entry, we suggest you read ```constata-cli entry preview entry-id```

  To sign them, you just run:
  ```
  constata-cli issuance sign <issuance-id>
  ```
  Each diploma is downloaded and signed locally on your device, which may take some time. If the process is interrupted, it can be resumed by re-running the command.

  *** About payment ***
  Timestamping will use your Constata tokens.
  For the purpose of this guide we assume you're just signed up to the freemium plan, which entitles you to 10 tokens a month, free of charge.
  When you create an Issuance, and before you sign it, you may want to check if you would need to buy tokens to process all its entries:
  constata-cli issuance tokens-needed <issuance-id>
  You can still sign even if you don't have the tokens yet, Constata will timestamp as many Entries as possible and email you a payment link to buy tokens and continue with the rest.


  ## 5. Wait for your certified diplomas.

  Once signed, the diplomas are queued to be timestamped internally by Constata and in Bitcoin's blockchain. This process may take up to two hours depending on blockchain conditions.
  We suggest you poll the state of your Issuance with a frequency of one minute or more, until its "state" is "completed", this command checks for the issuance to be completed, and exits immediately. Exit code 0 means the issuance is complete and all recipients have been notified.

  ```
  constata-cli issuance is_complete <issuance-id>
  ```

  You can export the Issuance for further processing. You will get the original CSV with extra columns appended to it, such as "constata_entry_admin_access_url", which is a special link created for each entry where the recipient canview or download their diploma, and configure sharing in social networks.

  ```
  constata-cli issuance export <issuance-id>
  ```

  # Putting it all together.

  Here's an example script with all steps summarized.

  CREDENTIALS="" # Change to path from your credentials.
  CSV_TO_PROCESS="example.csv" # Comment the line below if you change this.
  echo "id,name,test\nfoo,bar,baz" > $CSV_TO_PROCESS

  ISSUANCE_ID_FILE=CSV_TO_PROCESS.issuance_id
  CONSTATA_PASSWORD=$1

  if [ !stat $ISSUANCE_ID_FILE ]; then do


  fi;


  # Further comments and limitations

  ## There's a lot more to the command line utility.
    You can list and show your Issuances and their entries as JSON (we suggest using a custom command like jq to parse the results). You can also see your Constata token balance and your outstanding payment links.
    Explore the command line usage and documentation with
    ```constata-cli help```

  ## Max CSV size is 50mb.

  ## Recipient email notifications are rate limited in the freemium plan.

  ## Conclusion.

  ########

  ** Toda la command line está exportada como funciones.
  ** Documentamos con RDOC.
  ** Workflow como en el test de issuances.
  ** Buscar el .constata-conf en home, home/.config/, $XDG_HOME, etc.

  constata-cli issuance wizard-from-csv <csv_file> --conf -pass --template-values...


  - Use this shortcut if you DO NOT need to preview your issuance before signing.
  - Outputs the issuance id, always.
  - Exit code 1 means there was an error, outputs error message to stderr.
  - Exit code 1 outputs the issuance id to stdout.

  This will take up to one hour.

  You can check if its done with:
  constata-cli issuance is_done <issuance_id>

  Or, if you want to keep polling in a long running process, use the convenience method
  constata-cli issuance wait_until_done <issuance_id> [timeout_in_hours]

  You can also get notified by updates using a web callback:

  First you have to configure your web callbacks URL:
  constata-cli configure-callbacks-url "https://global-callbacks-url"

  Then on your server, the constata-cli can also help you parse the web callback, validating its signed by constata and that the event received:

  constata-cli process-issuance-done-web-callback <raw_callback_body>

  Will output: <issuance_id>

  An error exit code means either the callback did not come from constata, or it was some other type of callback sent by constata that was about an issuance being done. In Either case it's safe to ignore the callback.

  You can always export your issuance back to CSV with:
  constata-cli issuance export-to-csv <issuance_id>


  ## Longer version: Creating Issuances incrementally, and reviewing before signing.
  /*

    constata create-issuance-from-csv --input-name="some name" --input-template-kind="template kind"

    createIssuanceFromCsv(input: CreateIssuanceFromCsvInput!): Issuance!
    createIssuanceFromJson(input: CreateIssuanceFromJsonInput!): Issuance!
    appendEntriesToIssuance(input: AppendEntriesToIssuanceInput!): Issuance!
    updateIssuance(id: Int!): Issuance!

    updateWebCallbacksUrl(url: String): AccountState!

    createAttestation(input: AttestationInput!): Attestation!
    signingIterator(input: SigningIteratorInput!): Entry
    createKycRequest(input: KycRequestInput!): KycRequest!
    createEmailAddress(input: EmailAddressInput!): EmailAddress!
    createInvoiceLink(input: InvoiceLinkInput!): InvoiceLink!

    updateDownloadProofLink(input: DownloadProofLinkInput!): DownloadProofLink!
    deleteDownloadProofLink: DownloadProofLink!


    createEmailAddressVerification: EmailAddressVerification!
    updateTemplate(input: TemplateInput!): Template!
  */

  constata-cli create-issuance-from-json --template-values
    alternatively: constata-cli create-issuance-from-csv CSV_FILE ...template options...

  constata-cli issuance append-entries <id> [json data]

  constata-cli wait-until-issuance-is-created <id> [timeout]
  constata-cli issuance-is-created <id>
  constata-cli wait-until-issuance-is-created <id>
  constata-cli issuance-is-created <id>

  constata-cli get-sample-entry-preview <issuance_id>

      or if you want to be specific:

      constata-cli all-entries --filter

      constata-cli issuance get-entry-preview <entry_id>

  then you can sign all entries:

  constata-cli sign-issuance sign <id>

  /* And there's more */

  constata-cli issuance list ...

  constata-cli entries list ...

  constata-cli issuance export <issuance_id>

  constata-cli graphql "{ example account state graphql query }"

  ### Templates

  constata-cli templates list

  constata-cli templates create ...template options...

  ### Attestations

  ### Graphql

  constata-cli graphql --variables='{"first": 11}' 'mutation($input: CreateIssuanceFromJsonInput!) {
    createIssuanceFromJson(input: $input) {
      id
      templateId
      templateName
      templateKind
      state
      name
      createdAt
      errors
      tokensNeeded
      entriesCount
      adminVisitedCount
      publicVisitCount
      __typename
    }
  }'

</div>
{% endblock body %}
